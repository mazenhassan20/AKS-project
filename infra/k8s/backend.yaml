apiVersion: v1
kind: Service
metadata:
  name: backend
spec:
  selector:
    app: backend
  ports:
    - protocol: TCP
      port: 80
      targetPort: 3000
  type: LoadBalancer # Ø¹Ø´Ø§Ù† Ù†Ø§Ø®Ø¯ Public IP Ù†Ø¬Ø±Ø¨ Ø¨ÙŠÙ‡ Ø§Ù„Ù€ API
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: backend
        # Ø¯Ù‡ Ø±Ø§Ø¨Ø· ØµÙˆØ±ØªÙƒ ÙÙŠ Ø§Ù„Ù€ ACR
        image: mazenelsayad1234.azurecr.io/backend:v1
        ports:
        - containerPort: 3000
        env:
        # Ù‡Ù†Ø§ Ø§Ù„Ø³Ø­Ø±: Ø§Ù„ÙƒÙˆØ¯ Ù‡ÙŠÙƒÙ„Ù… Ø§Ù„Ø³ÙŠØ±ÙØ³ Ø§Ù„Ù„ÙŠ Ø§Ø³Ù…Ù‡Ø§ postgres
        - name: DATABASE_URL
          value: "postgresql://myuser:mypassword@postgres:5432/mydb?schema=public"
        - name: NODE_ENV
          value: "production"
# ... (Ø¬Ø²Ø¡ Ø§Ù„Ù€ containers Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨ØªØ§Ø¹Ùƒ) ...

      # ğŸ‘‡ Ø¶ÙŠÙ Ø§Ù„Ø¬Ø²Ø¡ Ø¯Ù‡ Ù‚Ø¨Ù„Ù‡ (ÙÙŠ Ù†ÙØ³ Ù…Ø³ØªÙˆÙ‰ containers)
      initContainers:
      - name: init-db
        image: mazenelsayad1234.azurecr.io/backend:latest # Ù†ÙØ³ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯
        command: ['sh', '-c', 'npx prisma db push']      # Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ù„ÙŠ ÙƒÙ†Øª Ø¨ØªÙƒØªØ¨Ù‡ ÙŠØ¯ÙˆÙŠ
        env:
        - name: DATABASE_URL # Ù„Ø§Ø²Ù… ØªØ¯ÙŠÙ„Ù‡ Ù†ÙØ³ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¯Ø§ØªØ§ Ø¨ÙŠØ²
          value: "postgresql://user:mypassword@postgres:5432/mydb?schema=public"
